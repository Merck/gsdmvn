---
title: "Group Sequential Bound Tables"
output:
  rmarkdown::html_vignette:
    css: "custom.css"
    df_print: paged
    toc: true
    toc_depth: 2
bibliography: gsDesign.bib
vignette: |
  %\VignetteIndexEntry{Group Sequential Bound Tables}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(tibble)
library(gt)
library(gsdmvn)
```

# Overview

This vignette introduces publication quality table production for group sequential designs in the **gsdmvn** package.  
It also demonstrates designs for an example scenario using multiple design approaches.
We divide the document into 3 parts:

- Design specification and derivation
- Printing design summary tables
- Details of output from design functions
- Details on table output options

The reader can decide which of these sections is of interest to them.

The function used to generate bounds tables is `gsdmvn::summary_bound()`. 
Users can use `gsdmvn::as_gt()` to format the above table using the **gt** package. 

In this vignette, we introduce a general approach to bound summaries by examples using different design approaches for a time-to-event outcome:

- the average hazard ratio (AHR) method extended from @Mukhopadhyay2020 using `gsdmvn::gs_design_ahr()`;
- the weighted logrank (WLR) method of @Yung2019Bcs using `gsdmvn::gs_design_wlr()`;
- The MaxCombo method of @NPHWG2021Design using `gsdmvn::gs_design_combo()`.

# Design specification and derivation

## Design parameters

The design parameters we use across the different designs derived are: 

```{r}
# enrollment/failure rates
enrollRates <- tibble::tibble(
   Stratum = "All", 
   duration = 12, 
   rate = 1)
failRates <- tibble::tibble(
   Stratum = "All", 
   duration = c(4, 100), 
   failRate = log(2) / 12,
   hr = c(1, .6), 
   dropoutRate = .001)

# Information fraction
IF <- (1:3)/3 
# Analysis times in months; first 2 will be ignored as IF will not be achieved
analysisTimes <- c(.01, .02, 36)  

# Experimental / Control randomization ratio
ratio <- 1 

# 1-sided Type I error
alpha <- 0.025 
# Type II error (1 - power)
beta <- 0.1 

# create a gsDesign object to calculate the fixed boundary
# In the future, we will use Lan-DeMets spending to approximate O'Brien-Fleming bound
x <- 
# Upper bound
upper <- gsdmvn::gs_spending_bound # alpha-spending bound
upar <- list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)
upper <- gsdmvn::gs_b             
upar <- gsDesign::gsDesign(k = 3, test.type = 1, n.I = c(.25, .75, 1), sfu = gsDesign::sfLDOF, sfupar = NULL)$upper$bound            
# Lower bound
lower <- gsdmvn::gs_b            # gsdmvn::gs_spending_bound # beta-spending bound
lpar <- c(qnorm(.1), -Inf, -Inf) # list(sf = gsDesign::sfHSD, total_spend = 0.1, param = 0, timing = NULL)

# Fleming-Harrington (FH) weight functions for weighted logrank (WLR)
wgt00 <- function(x, arm0, arm1){ # Equal weighting for logrank
                 gsdmvn:::wlr_weight_fh(x, arm0, arm1, rho = 0, gamma = 0)}
wgt05 <- function(x, arm0, arm1){ # Early downweighting with FH(0,.5) 
                 gsdmvn:::wlr_weight_fh(x, arm0, arm1, rho = 0, gamma = .5)}

# Both of above tests for MaxCombo: logrank and FH(0,.5)
fh_test <- rbind(
      # Include logrank for all 3 analyses
      data.frame(rho = 0, gamma = 0, tau = -1, test = 1, Analysis = 1:3, analysisTimes = c(12, 24, 36)), 
      # Only include FH(0,.5) for analyses 2 and 3
      data.frame(rho = c(0, 0.5), gamma = 0.5, tau = -1, test = 2:3, Analysis = 3, analysisTimes = 36)
      )
```

# Deriving designs

## AHR design derivation 

Using the design parameters above, the AHR design is derived as follows:

By using the design parameters above, one can generate an AHR model by `gs_design_ahr` as

```{r}
x_ahr <- gs_design_ahr(
   enrollRates = enrollRates,
   failRates = failRates,
   IF = IF, 
   analysisTimes = analysisTimes, 
   ratio = ratio, 
   alpha = alpha, 
   beta = beta, 
   upper = upper,
   upar = upar,
   lower = lower,
   lpar = lpar
)
```

## WLR design derivation

## MaxCombo design derivation

# Default summary table production

(This will only have 4 tables, one from each design)

# Details of output from design functions

## Failure rates
(same for all designs)

## Enrollment

Same table structure, same enrollment period durations for each rate, rates differ between designs only by a multiplicative constant.

## Analysis

One row per analysis per hypothesis. Columns can vary with different defaults for each design option.

## Bounds

One row per analysis per bound per hypothesis. Columns can vary with different defaults for each design option.


The output of `x_ahr` is a list including

- `enrollRates`: the enrollment rates
- `failRates`: the failure rates
- `bounds`: the summary of the crossing probabilities under H0 \& H1
- `analysis`: the summary of each analysis



# Detailed summary table formatting

Here we demonstrate options for formatting analysis rows, bound rows as well as other table parameters such as titles, labels and footnotes.


The direct output of `bounds` and `analysis` tables is useful for understanding commonalities in how designs are summarized for different models:
```{r}
x_ahr$bounds %>% 
   mutate_if(is.numeric, round, digits = 4)  %>% 
   gt::gt()
```

```{r}
x_ahr$analysis %>% 
   mutate_if(is.numeric, round, digits = 4) %>% 
   gt::gt()
```

The `summary_bound()` function produces an overall summary table for bounds for publication in a protocol. 
The default output of `summary_bound()` for the AHR method is
```{r}
summary_bound(x_ahr) %>% 
   mutate_if(is.numeric, round, digits = 4) %>% 
   gt::gt()
```

In the above default table, the variables used to summarize each analysis includes `Analysis`, `Time`, `N`(sample size), `Events`, `AHR`, and `IF` (information fraction). 
But users can customize these variables chosen using `analysis_vars = ...` and the corresponding decimals displayed using the argument `analysis_decimals = ...`. 
For example
```{r}
summary_bound(
   x_ahr,
   analysis_vars = c("N", "Events"),
   analysis_decimals = c(1, 1)) %>% 
   mutate_if(is.numeric, round, digits = 4) %>% 
   gt::gt()
```
Please note that there is no need to input `"Analysis"` into `analysis_vars = ...` as it will always appear.

Besides, users can also customize the bound names. 
In the default output, the bound name is `c("Efficacy", "Futility")`, which can be changed into 
`c("A is better", "B is better")` for a 2-sided design by using the argument `bound_names = ...`.
For example,
```{r}
summary_bound(
   x_ahr,
   bound_names = c("A is better", "B is better")) %>% 
   mutate_if(is.numeric, round, digits = 4) %>% 
   gt::gt()
```

Finally, users can also use `as_gt()` to get the the above R table into a gt table.
Furthermore, they can edit the title/subtitle/spanner/footnotes of the gt table by using the arguments in `summary_bound`. 
```{r}
summary_bound(x_ahr) %>% 
   as_gt(title = "Summary of the Crossing Probability",
         subtitle = "by Using gs_design_ahr",
         colname_spanner = "Cumulative boundary crossing probability",
         colname_spannersub = c("Alternate hypothesis", "Null hypothesis"),
         footnote = list(content = c("approximate hazard ratio to cross bound.", 
                                     "gs_design_ahr is a function in gsdmvn.",
                                     "AHR is average hazard ratio; IF is information fraction."),
                         location = c("~HR at bound", NA, NA),
                         attr = c("colname", "subtitle", "analysis")))
```

The above objective can also be realized by using functions in the R package `gt` for custom design of table layout. 
We note that `as_gt()` always produces a `gt` object and, thus, can be further customized with **gt** package formatting functions.
In the future, we to support rich text format using a function `as_rtf()` in a fashion similar to `as_gt()`.

# WLR method 

In this section, we discuss the procedure to generate a bound table under the frame work of WLR method.

```{r}
x_wlr <- gs_design_wlr(
   enrollRates = enrollRates,
   failRates = failRates,
   weight = wgt05, 
   IF = NULL, 
   analysisTimes = sort(unique(x_ahr$analysis$Time)), 
   ratio = ratio, 
   alpha = alpha, 
   beta = beta,   
   upper = upper,
   upar = upar,
   lower = lower,
   lpar = lpar
)
```

One can use `x_wlr$bounds`/`x_wlr$analysis` to get a simplified bounds/analysis table, which is similar to that by `x_ahr`.
To get a comprehensive bounds summary table, one can use 
```{r}
summary_bound(x_wlr) %>% 
   mutate_if(is.numeric, round, digits = 4) %>% 
   gt::gt()
```

The above table can also be format by `as_gt()` as
```{r}
summary_bound(x_wlr) %>% as_gt()
```

# MAX COMBO method 

In this section, we discuss the procedure to generate a bound table under the frame work of MAX COMBO method.

```{r}
x_combo <- gsdmvn::gs_design_combo(
  ratio = ratio, 
  alpha = alpha,
  beta = beta, 
  enrollRates = enrollRates, 
  failRates = failRates, 
  fh_test = fh_test,
  upper = gsdmvn::gs_b,
  upar = upar,
  lower = gsdmvn::gs_b,
  lpar = lpar)
```

One can use `x_combo$enrollRates`, `x_combo$failRates`, `x_combo$bounds`/`x_combo$analysis` to get a simplified enrollment rates/failure rates/bounds/analysis table, which is similar to that by `x_ahr`.
To get a comprehensive bounds summary table, one can use 

```{r}
summary_bound(x_combo) %>%
   mutate_if(is.numeric, round, digits = 4)  %>% 
   gt::gt()
```

One can also use `as_gt()` to custom the gt style of the bounds table.
```{r}
summary_bound(x_combo) %>% as_gt()
```

# References
