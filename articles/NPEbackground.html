<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="gsdmvn">
<title>Non-Proportional Effect Size in Group Sequential Design • gsdmvn</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Non-Proportional Effect Size in Group Sequential Design">
<meta property="og:description" content="gsdmvn">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">gsdmvn</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-2">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/DesignWithAverageHazardRatio.html">Design Using Average Hazard Ratio</a>
    <a class="dropdown-item" href="../articles/DesignWithSpending.html">Trial design with spending under NPH</a>
    <a class="dropdown-item" href="../articles/NPEbackground.html">Non-Proportional Effect Size in Group Sequential Design</a>
    <a class="dropdown-item" href="../articles/NPEbounds.html">Computing Bounds Under Non-Constant Treatment Effect</a>
    <a class="dropdown-item" href="../articles/PowerEvaluationWithSpending.html">Power Evaluation with Spending bounds</a>
    <a class="dropdown-item" href="../articles/QuickStart.html">Quick Start for NPH Sample Size and Power</a>
    <a class="dropdown-item" href="../articles/SpendingTimeExamples.html">Spending Time Examples</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Merck/gsdmvn/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">
<script src="NPEbackground_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Non-Proportional Effect Size in Group Sequential Design</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Merck/gsdmvn/blob/HEAD/vignettes/NPEbackground.Rmd" class="external-link"><code>vignettes/NPEbackground.Rmd</code></a></small>
      <div class="d-none name"><code>NPEbackground.Rmd</code></div>
    </div>

    
    
<div class="section level1">
<h1 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h1>
<p>The acronym NPES is short for non-proportional effect size. While it is motivated primarily by a use for when designing a time-to-event trial under non-proportional hazards (NPH), we have simplified and generalized the concept here. The model is likely to be useful for rank-based survival tests beyond the logrank test that will be considered initially by <span class="citation">Tsiatis (1982)</span>. It could also be useful in other situations where treatment effect may vary over time in a trial for some reason. We generalize the framework of Chapter 2 of <span class="citation">Proschan, Lan, and Wittes (2006)</span> to incorporate the possibility of the treatment effect changing during the course of a trial in some systematic way. This vignettes addresses distribution theory and initial technical issues around computing</p>
<ul>
<li>boundary crossing probabilities</li>
<li>bounds satisfying targeted boundary crossing probabilities</li>
</ul>
<p>This is then applied to generalize computational algorithms provided in Chapter 19 of <span class="citation">Jennison and Turnbull (2000)</span> that are used to compute boundary crossing probabilities as well as boundaries for group sequential designs. Additional specifics around boundary computation, power and sample size are provided in a separate vignette.</p>
</div>
<div class="section level1">
<h1 id="the-probability-model">The probability model<a class="anchor" aria-label="anchor" href="#the-probability-model"></a>
</h1>
<div class="section level2">
<h2 id="the-continuous-model-and-e-process">The continuous model and E-process<a class="anchor" aria-label="anchor" href="#the-continuous-model-and-e-process"></a>
</h2>
<p>We consider a simple example here to motivate distribution theory that is quite general and applies across many situations. For instance <span class="citation">Proschan, Lan, and Wittes (2006)</span> immediately suggest paired observations, time-to-event and binary outcomes as endpoints where the theory is applicable.</p>
<p>We assume for a given integer <span class="math inline">\(N&gt;0\)</span> that <span class="math inline">\(X_{i}\)</span> are independent, <span class="math inline">\(i=1,2,\ldots\)</span>. For some integer <span class="math inline">\(K\le N\)</span> we assume we will perform analysis <span class="math inline">\(K\)</span> times after <span class="math inline">\(0&lt;n_1&lt;n_2,\ldots ,n_K = N\)</span> observations are available for analysis. Note that we have not confined <span class="math inline">\(n\le N\)</span>, but <span class="math inline">\(N\)</span> can be considered the final planned sample size. <span class="citation">Proschan, Lan, and Wittes (2006)</span> refer to the estimation or E-process which we extend here to</p>
<p><span class="math display">\[\hat{\theta}_k = \frac{\sum_{i=1}^{n_k} X_{i}}{n_k}\equiv \bar X_{k}.\]</span> While <span class="citation">Proschan, Lan, and Wittes (2006)</span> have used <span class="math inline">\(\delta\)</span> instead of <span class="math inline">\(\theta\)</span> in our notation, we stick more closely to the notation of <span class="citation">Jennison and Turnbull (2000)</span> where <span class="math inline">\(\theta\)</span> is used. For our example, we see <span class="math inline">\(\hat{\theta}_k\equiv\bar X_k\)</span> represents the sample average at analysis <span class="math inline">\(k\)</span>, <span class="math inline">\(1\le k\le K\)</span>. With a survival endpoint, <span class="math inline">\(\hat\theta_k\)</span> would typically represent a Cox model coefficient representing the logarithm of the hazard ratio for experimental vs control treatment and <span class="math inline">\(n_k\)</span> would represent the planned number of events at analysis <span class="math inline">\(k\)</span>, <span class="math inline">\(1\le k\le K.\)</span> Denoting <span class="math inline">\(t_k=n_k/N\)</span>, we assume that for some real-valued function <span class="math inline">\(\theta(t)\)</span> for <span class="math inline">\(t\ge 0\)</span> we have for <span class="math inline">\(1\le k\le K\)</span></p>
<p><span class="math display">\[E(\hat{\theta}_k) =\theta(t_k) =E(\bar X_k).\]</span> In the models of <span class="citation">Proschan, Lan, and Wittes (2006)</span> and <span class="citation">Jennison and Turnbull (2000)</span> we would have <span class="math inline">\(\theta(t)\)</span> equal to some constant <span class="math inline">\(\theta\)</span>. We assume further that for <span class="math inline">\(i=1,2,\ldots\)</span> <span class="math display">\[\hbox{Var}(X_{i})=1.\]</span> The sample average variance under this assumption is for <span class="math inline">\(1\le k\le K\)</span></p>
<p><span class="math display">\[\hbox{Var}(\hat\theta(t_k))=\hbox{Var}(\bar X_k) =  1/ n_k.\]</span> The statistical information for the estimate <span class="math inline">\(\hat\theta(t_k)\)</span> for <span class="math inline">\(1\le k\le K\)</span> for this case is <span class="math display">\[ \mathcal{I}_k \equiv \frac{1}{\hbox{Var}(\hat\theta(t_k))} = n_k.\]</span> We now see that <span class="math inline">\(t_k\)</span>, <span class="math inline">\(1\le k\le K\)</span> is the so-called information fraction at analysis <span class="math inline">\(k\)</span> in that <span class="math inline">\(t_k=\mathcal{I}_k/\mathcal{I}_K.\)</span></p>
</div>
<div class="section level2">
<h2 id="z-process">Z-process<a class="anchor" aria-label="anchor" href="#z-process"></a>
</h2>
<p>The Z-process is commonly used (e.g., <span class="citation">Jennison and Turnbull (2000)</span>) and will be used below to extend the computational algorithm in Chapter 19 of <span class="citation">Jennison and Turnbull (2000)</span> by defining equivalently in the first and second lines below for <span class="math inline">\(k=1,\ldots,K\)</span></p>
<p><span class="math display">\[Z_{k} = \frac{\hat\theta_k}{\sqrt{\hbox{Var}(\hat\theta_k)}}= \sqrt{\mathcal{I}_k}\hat\theta_k= \sqrt{n_k}\bar X_k.\]</span></p>
<p>The variance for <span class="math inline">\(1\le k\le K\)</span> is <span class="math display">\[\hbox{Var}(Z_k) = 1\]</span> and the expected value is</p>
<p><span class="math display">\[E(Z_{k})= \sqrt{\mathcal{I}_k}\theta(t_{k})= \sqrt{n_k}E(\bar X_k) .\]</span></p>
</div>
<div class="section level2">
<h2 id="b-process">B-process<a class="anchor" aria-label="anchor" href="#b-process"></a>
</h2>
<p>B-values are mnemonic for Brownian motion. For <span class="math inline">\(1\le k\le K\)</span> we define <span class="math display">\[B_{k}=\sqrt{t_k}Z_k\]</span> which implies <span class="math display">\[ E(B_{k}) = \sqrt{t_{k}\mathcal{I}_k}\theta(t_k) = t_k \sqrt{\mathcal{I}_K} \theta(t_k) = \mathcal{I}_k\theta(t_k)/\sqrt{\mathcal{I}_K}\]</span> and <span class="math display">\[\hbox{Var}(B_k) = t_k.\]</span></p>
<p>For our example, we have</p>
<p><span class="math display">\[B_k=\frac{1}{\sqrt N}\sum_{i=1}^{n_k}X_i.\]</span> It can be useful to think of <span class="math inline">\(B_k\)</span> as a sum of independent random variables.</p>
</div>
<div class="section level2">
<h2 id="summary-of-e--z--and-b-processes">Summary of E-, Z- and B-processes<a class="anchor" aria-label="anchor" href="#summary-of-e--z--and-b-processes"></a>
</h2>
<table class="table">
<colgroup>
<col width="22%">
<col width="17%">
<col width="47%">
<col width="12%">
</colgroup>
<thead><tr class="header">
<th align="left">Statistic</th>
<th align="left">Example</th>
<th align="left">Expected value</th>
<th align="left">Variance</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\hat\theta_k\)</span></td>
<td align="left"><span class="math inline">\(\bar X_k\)</span></td>
<td align="left"><span class="math inline">\(\theta(t_k)\)</span></td>
<td align="left"><span class="math inline">\(\mathcal{I}_k^{-1}\)</span></td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(Z_k=\sqrt{\mathcal{I}_k}\hat\theta_k\)</span></td>
<td align="left"><span class="math inline">\(\sqrt{n_k}\bar X_k\)</span></td>
<td align="left"><span class="math inline">\(\sqrt{\mathcal{I}_k}\theta(t_k)\)</span></td>
<td align="left"><span class="math inline">\(1\)</span></td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(B_k=\sqrt{t_k}Z_k\)</span></td>
<td align="left"><span class="math inline">\(\sum_{i=1}^{n_k}X_i/\sqrt N\)</span></td>
<td align="left"><span class="math inline">\(t_k\sqrt{\mathcal{I}_K}\theta(t_k)=\mathcal{I}_k\theta(t_k)/\sqrt{\mathcal{I}_K}\)</span></td>
<td align="left"><span class="math inline">\(t_k\)</span></td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="conditional-independence-covariance-and-canonical-form">Conditional independence, covariance and canonical form<a class="anchor" aria-label="anchor" href="#conditional-independence-covariance-and-canonical-form"></a>
</h2>
<p>We assume independent increments in the B-process. That is, for <span class="math inline">\(1\le j &lt; k\le K\)</span> <span class="math display">\[\tag{1} B_k - B_j \sim \hbox{Normal} (\sqrt{\mathcal{I}_K}(t_k\theta(t_k)- t_j\theta(t_j)), t_k-t_j)\]</span> independent of <span class="math inline">\(B_1,\ldots,B_j\)</span>. As noted above, for a given <span class="math inline">\(1\le k\le K\)</span> we have for our example <span class="math display">\[B_j=\sum_{i=1}^{n_j}X_i / \sqrt N.\]</span> Because of independence of the sequence <span class="math inline">\(X_i\)</span>, <span class="math inline">\(i=1,2,\ldots\)</span>, we immediately have for <span class="math inline">\(1\le j\le k\le K\)</span> <span class="math display">\[\hbox{Cov}(B_j,B_k) = \hbox{Var}(B_j) = t_j.\]</span> This leads further to <span class="math display">\[\hbox{Corr}(B_j,B_k)=\frac{t_j}{\sqrt{t_jt_k}}=\sqrt{t_j/t_k}=\hbox{Corr}(Z_j,Z_k)=\hbox{Cov}(Z_j,Z_k)\]</span> which is the covariance structure in the so-called <em>canonical form</em> of <span class="citation">Jennison and Turnbull (2000)</span>. For our example, we have <span class="math display">\[B_k=\frac{1}{\sqrt N}\sum_{i=1}^{n_k}X_i\]</span> and <span class="math display">\[B_k-B_j=\frac{1}{\sqrt N}\sum_{i=n_j + 1}^{n_k}X_i\]</span> and the covariance is obvious. We assume independent increments in the B-process that will be demonstrated for the simple example above. That is, for <span class="math inline">\(1\le j &lt; k\le K\)</span> <span class="math display">\[\tag{1} B_k - B_j \sim \hbox{Normal} (\mathcal{I}_k\theta(t_k)- \mathcal{I}_j\theta(t_j), t_k-t_j)\]</span> independent of <span class="math inline">\(B_1,\ldots,B_j\)</span>. For a given <span class="math inline">\(1\le j\le k\le K\)</span> we have for our example <span class="math display">\[B_j=\sum_{i=1}^{n_j}X_i / (\sqrt N\sigma).\]</span> Because of independence of the sequence <span class="math inline">\(X_i\)</span>, <span class="math inline">\(i=1,2,\ldots\)</span>, we immediately have for <span class="math inline">\(1\le j\le k\le K\)</span> <span class="math display">\[\hbox{Cov}(B_j,B_k) = \hbox{Var}(B_j) = t_j/t_k =\mathcal{I}_j/\mathcal{I}_k.\]</span> This leads to <span class="math display">\[\mathcal{I}_j/\mathcal{I}_k=\sqrt{t_j/t_k}=\hbox{Corr}(B_j,B_k)=\hbox{Corr}(Z_j,Z_k)=\hbox{Cov}(Z_j,Z_k)\]</span> which is the covariance structure in the so-called <em>canonical form</em> of <span class="citation">Jennison and Turnbull (2000)</span>. The independence of <span class="math inline">\(B_j\)</span> and <span class="math display">\[B_k-B_j=\sum_{i=n_j + 1}^{n_k}X_i/(\sqrt N\sigma)\]</span> is obvious for this example.</p>
</div>
</div>
<div class="section level1">
<h1 id="test-bounds-and-crossing-probabilities">Test bounds and crossing probabilities<a class="anchor" aria-label="anchor" href="#test-bounds-and-crossing-probabilities"></a>
</h1>
<p>In this section we define notation for bounds and boundary crossing probabilities for a group sequential design. We also define an algorithm for computing bounds based on a targeted boundary crossing probability at each analysis. The notation will be used elsewhere for defining one- and two-sided group sequential hypothesis testing. A value of <span class="math inline">\(\theta(t)&gt;0\)</span> will reflect a positive benefit.</p>
<p>For <span class="math inline">\(k=1,2,\ldots,K-1\)</span>, interim cutoffs <span class="math inline">\(-\infty \le a_k&lt; b_k\le \infty\)</span> are set; final cutoffs <span class="math inline">\(-\infty \le a_K\leq b_K &lt;\infty\)</span> are also set. An infinite efficacy bound at an analysis means that bound cannot be crossed at that analysis. Thus, <span class="math inline">\(3K\)</span> parameters define a group sequential design: <span class="math inline">\(a_k\)</span>, <span class="math inline">\(b_k\)</span>, and <span class="math inline">\(\mathcal{I}_k\)</span>, <span class="math inline">\(k=1,2,\ldots,K\)</span>.</p>
<div class="section level2">
<h2 id="notation-for-boundary-crossing-probabilities">Notation for boundary crossing probabilities<a class="anchor" aria-label="anchor" href="#notation-for-boundary-crossing-probabilities"></a>
</h2>
<p>We now apply the above distributional assumptions to compute boundary crossing probabilities. We use a shorthand notation in this section to have <span class="math inline">\(\theta\)</span> represent <span class="math inline">\(\theta()\)</span> and <span class="math inline">\(\theta=0\)</span> to represent <span class="math inline">\(\theta(t)\equiv 0\)</span> for all <span class="math inline">\(t\)</span>. We denote the probability of crossing the upper boundary at analysis <span class="math inline">\(k\)</span> without previously crossing a bound by</p>
<p><span class="math display">\[\alpha_{k}(\theta)=P_{\theta}(\{Z_{k}\geq b_{k}\}\cap_{j=1}^{i-1}\{a_{j}\le Z_{j}&lt; b_{j}\}),\]</span> <span class="math inline">\(k=1,2,\ldots,K.\)</span></p>
<p>Next, we consider analogous notation for the lower bound. For <span class="math inline">\(k=1,2,\ldots,K\)</span> denote the probability of crossing a lower bound at analysis <span class="math inline">\(k\)</span> without previously crossing any bound by</p>
<p><span class="math display">\[\beta_{k}(\theta)=P_{\theta}((Z_{k}&lt; a_{k}\}\cap_{j=1}^{k-1}\{ a_{j}\le Z_{j}&lt; b_{j}\}).\]</span> For symmetric testing for analysis <span class="math inline">\(k\)</span> we would have <span class="math inline">\(a_k= - b_k\)</span>, <span class="math inline">\(\beta_k(0)=\alpha_k(0),\)</span> <span class="math inline">\(k=1,2,\ldots,K\)</span>. The total lower boundary crossing probability for a trial is denoted by <span class="math display">\[\beta(\theta)\equiv\sum_{k=1}^{K}\beta_{k}(\theta).\]</span> Note that we can also set <span class="math inline">\(a_k= -\infty\)</span> for any or all analyses if a lower bound is not desired, <span class="math inline">\(k=1,2,\ldots,K\)</span>. For <span class="math inline">\(k&lt;K\)</span>, we can set <span class="math inline">\(b_k=\infty\)</span> where an upper bound is not desired. Obviously, for each <span class="math inline">\(k\)</span>, we want either <span class="math inline">\(a_k&gt;-\infty\)</span> or <span class="math inline">\(b_k&lt;\infty\)</span>.</p>
</div>
<div class="section level2">
<h2 id="recursive-algorithms">Recursive algorithms<a class="anchor" aria-label="anchor" href="#recursive-algorithms"></a>
</h2>
<p>We now provide a small update to the algorithm of Chapter 19 of <span class="citation">Jennison and Turnbull (2000)</span> to do the numerical integration required to compute the boundary crossing probabilites of the previous section and also identifying group sequential boundaries satisfying desired characteristics. The key to these calculations is the conditional power identitity in equation (1) above which allows building recursive numerical integration identities to enable simple, efficient numerical integration.</p>
<p>We define</p>
<p><span class="math display">\[g_1(z;\theta) = \frac{d}{dz}P(Z_1\le z) = \phi\left(z - \sqrt{\mathcal{I}_1}\theta(t_1)\right)\tag{2}\]</span></p>
<p>and for <span class="math inline">\(k=2,3,\ldots K\)</span> we recursively define the subdensity function</p>
<p><span class="math display">\[\begin{align}
g_k(z; \theta) &amp;= \frac{d}{dz}P_\theta(\{Z_k\le z\}\cap_{j=1}^{k-1}\{a_j\le Z_j&lt;b_j\}) \\
 &amp;=\int_{a_{k-1}}^{b_{k-1}}\frac{d}{dz}P_\theta(\{Z_k\le z |Z_{k-1}=z_{k-1}\})g_{k-1}(z_{k-1}; \theta)dz_{k-1}\\
 &amp;=\int_{a_{k-1}}^{b_{k-1}}f_k(z_{k-1},z;\theta)g_{k-1}(z_{k-1}; \theta)dz_{k-1}.\tag{3}
 \end{align}
\]</span> The bottom line notation here is the same as on p. 347 in <span class="citation">Jennison and Turnbull (2000)</span>. However, <span class="math inline">\(f_k()\)</span> here takes a slightly different form.</p>
<p><span class="math display">\[\begin{align}
f_k(z_{k-1},z;\theta) &amp;=\frac{d}{dz}P_\theta(\{Z_k\le z |Z_{k-1}=z_{k-1}\})\\
 &amp;=\frac{d}{dz}P_\theta(B_k - B_{k-1} \le z\sqrt{t_k}-z_{k-1}\sqrt{t_{k-1}})\\
 &amp;=\frac{d}{dz}\Phi\left(\frac{z\sqrt{t_k}-z_{k-1}\sqrt{t_{k-1}}-\sqrt{\mathcal{I}_K}(t_k\theta(t_k)- t_{k-1}\theta(t_{k-1}))}{\sqrt{t_k-t_{k-1}}}\right)\\
 &amp;=\frac{\sqrt{t_k}}{\sqrt{t_k-t_{k-1}}}\phi\left(\frac{z\sqrt{t_k}-z_{k-1}\sqrt{t_{k-1}}-\sqrt{\mathcal{I}_K}(t_k\theta(t_k)- t_{k-1}\theta(t_{k-1}))}{\sqrt{t_k-t_{k-1}}}\right)\\
 &amp;=\frac{\sqrt{\mathcal{I}_k}}{\sqrt{\mathcal{I}_k-\mathcal{I}_{k-1}}}\phi\left(\frac{z\sqrt{\mathcal{I}_k}-z_{k-1}\sqrt{\mathcal{I}_{k-1}}-(\mathcal{I}_k\theta(t_k)- \mathcal{I}_{k-1}\theta(t_{k-1}))}{\sqrt{\mathcal{I}_k-\mathcal{I}_{k-1}}}\right).\tag{3}
\end{align}\]</span></p>
<p>We have worked towards this last line due to its comparability to equation (19.4) on p. 347 of <span class="citation">Jennison and Turnbull (2000)</span> which assumes <span class="math inline">\(\theta(t_k)=\theta\)</span> for some constant <span class="math inline">\(\theta\)</span>; we re-write that equation slightly here as:</p>
<p><span class="math display">\[f_k(z_{k-1},z;\theta) = \frac{\sqrt{\mathcal{I}_k}}{\sqrt{\mathcal{I}_k-\mathcal{I}_{k-1}}}\phi\left(\frac{z\sqrt{\mathcal{I}_k}-z_{k-1}\sqrt{\mathcal{I}_{k-1}}-\theta(\mathcal{I}_k- \mathcal{I}_{k-1})}{\sqrt{\mathcal{I}_k-\mathcal{I}_{k-1}}}\right).\tag{4}\]</span> This is really the only difference in the computational algorithm for boundary crossing probabilities from the <span class="citation">Jennison and Turnbull (2000)</span> algorithm. Using the above recursive approach we can compute for <span class="math inline">\(k=1,2,\ldots,K\)</span></p>
<p><span class="math display">\[\alpha_{k}(\theta)=\int_{b_k}^\infty g_k(z;\theta)dz\tag{5}\]</span> and <span class="math display">\[\beta_{k}(\theta)=\int_{-\infty}^{a_k} g_k(z;\theta)dz.\tag{6}\]</span></p>
</div>
<div class="section level2">
<h2 id="deriving-spending-boundaries">Deriving spending boundaries<a class="anchor" aria-label="anchor" href="#deriving-spending-boundaries"></a>
</h2>
<p>We can now derive boundaries satisfying given boundary crossing probabilities using equations (2-6) above. Suppose for we have specified <span class="math inline">\(b_1,\ldots,b_{k-1}\)</span> and <span class="math inline">\(a_1,\ldots,a_{k-1}\)</span> and now wish to derive <span class="math inline">\(a_k\)</span> and <span class="math inline">\(b_k\)</span> such that equations (5) and (6) hold. We write the upper bound as a function of the probability of crossing we wish to derive.</p>
<p><span class="math display">\[\pi_k(b;\theta) = \int_b^\infty g_k(z;\theta)dz\]</span> <span class="math display">\[\pi_k^\prime(b;\theta) =\frac{d}{db}\pi_k(b;\theta)= -g_k(b; \theta).\tag{7}\]</span> If we have a value <span class="math inline">\(\pi_k(b^{(i)};\theta)\)</span> we can use a first order Taylor’s series expansion to approximate</p>
<p><span class="math display">\[\pi_k(b;\theta)\approx \pi_k(b^{(i)};\theta)+(b-b^{(i)})\pi_k^\prime(b^{(i)};\theta)\]</span> We set <span class="math inline">\(b^{(i+1)}\)</span> such that</p>
<p><span class="math display">\[\alpha_k(\theta)=\pi_k(b^{(i)}; \theta) + (b^{(i+1)}-b^{(i)})\pi^\prime(b^{(i)};\theta).\]</span></p>
<p>Solving for <span class="math inline">\(b^{(i+1)}\)</span> we have</p>
<p><span class="math display">\[b^{(i+i)} = b^{(i)} + \frac{\alpha_k(\theta) - \pi_k(b^{(i)};\theta)}{\pi_k^\prime(b^{(i)}; \theta)}= b^{(i)} - \frac{\alpha_k(\theta) - \pi_k(b^{(i)};\theta)}{g_k(b^{(i)}; \theta)}\tag{8}\]</span> and iterate until <span class="math inline">\(|b^{(i+1)}-b^{(i)}|&lt;\epsilon\)</span> for some tolerance level <span class="math inline">\(\epsilon&gt;0\)</span> and <span class="math inline">\(\pi_k(b^{(i+1)};\theta)-\alpha_k(\theta)\)</span> is suitably small. A simple starting value for any <span class="math inline">\(k\)</span> is</p>
<p><span class="math display">\[b^{(0)} = \Phi^{-1}(1- \alpha_k(\theta)) + \sqrt{\mathcal{I}_k}\theta(t_k).\tag{9}\]</span> Normally, <span class="math inline">\(b_k\)</span> will be calculated with <span class="math inline">\(\theta(t_k)=0\)</span> for <span class="math inline">\(k=1,2,\ldots,K\)</span> which simplifies the above. However, <span class="math inline">\(a_k\)</span> computed analogously will often use a non-zero <span class="math inline">\(\theta\)</span> to enable so-called <span class="math inline">\(\beta\)</span>-spending.</p>
</div>
</div>
<div class="section level1">
<h1 id="numerical-integration">Numerical integration<a class="anchor" aria-label="anchor" href="#numerical-integration"></a>
</h1>
<p>The numerical integration required to compute boundary probabilities and derive boundaries is the same as that defined in section 19.3 of <span class="citation">Jennison and Turnbull (2000)</span>. The single change is the replacement of the non-proportional effect size assumption of equation (3) above replacing the equivalent of equation (4) used for a constant effect size as in <span class="citation">Jennison and Turnbull (2000)</span>.</p>
<div class="section level2">
<h2 id="demonstrating-calculations">Demonstrating calculations<a class="anchor" aria-label="anchor" href="#demonstrating-calculations"></a>
</h2>
<p>We walk through how to perform the basic calculations above. The basic scenario will have one interim analysis in addition to the final analysis. We will target Type I error <span class="math inline">\(\alpha=0.025\)</span> and Type II error <span class="math inline">\(\beta = 0.1\)</span>, the latter corresponding to a target of 90% power. We will assume a power spending function with <span class="math inline">\(\rho=2\)</span> for both bounds. That is, for information fraction <span class="math inline">\(t\)</span>, the cumulative spending will be <span class="math inline">\(\alpha \time t^2\)</span> for the upper bound and <span class="math inline">\(\beta \times t^2\)</span> for the lower bound. Statistical information will be 1 for the first analysis and 4 for the final analysis, leading to information fraction <span class="math inline">\(t_1= 1/4, t_2=1\)</span> for the interim and final, respectively. We assume <span class="math inline">\(\theta_1 = .5\)</span>, <span class="math inline">\(\theta_3=1.5\)</span>.</p>
<ul>
<li>Set up overall study parameters</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Information for both null and alternative</span>
<span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>
<span class="co"># information fraction</span>
<span class="va">timing</span> <span class="op">&lt;-</span> <span class="va">info</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">info</span><span class="op">)</span> 
<span class="co"># Type I error</span>
<span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.025</span>
<span class="co"># Type II error (1 - power)</span>
<span class="va">beta</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>
<span class="co"># Cumulative alpha-spending at IA, Final</span>
<span class="va">alphaspend</span> <span class="op">&lt;-</span> <span class="va">alpha</span> <span class="op">*</span> <span class="va">timing</span><span class="op">^</span><span class="fl">2</span>
<span class="co"># Cumulative beta-spending at IA, Final</span>
<span class="va">betaspend</span> <span class="op">&lt;-</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">timing</span><span class="op">^</span><span class="fl">2</span>
<span class="co"># Average treatment effect at analyses</span>
<span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span></code></pre></div>
<ul>
<li>Calculate interim bounds</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Upper bound under null hypothesis</span>
<span class="va">b1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="va">alphaspend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co"># Lower bound under alternate hypothesis</span>
<span class="va">a1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="va">betaspend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
<span class="co"># Compare probability of crossing vs target for bounds:</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Upper bound ="</span>, <span class="va">b1</span>, <span class="st">"Target spend="</span>, <span class="va">alphaspend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,
    <span class="st">"Actual spend="</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">b1</span>, lower.tail<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Upper bound = 2.955167 Target spend= 0.0015625 Actual spend= 0.0015625</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Lower bound under alternate hypothesis</span>
<span class="va">a1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="va">betaspend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
<span class="co"># Compare probability of crossing vs target for bounds:</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Lower bound ="</span>, <span class="va">a1</span>, <span class="st">"Target spend="</span>, <span class="va">betaspend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,
    <span class="st">"Actual spend="</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">a1</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Lower bound = -1.997705 Target spend= 0.00625 Actual spend= 0.00625</span></code></pre></div>
<ul>
<li>Set up numerical integration grid for next (final) analysis</li>
</ul>
<p>We set up a table for numerical integration over the continuation region which we can subsequently use to compute boundary crossing probabilities for bounds at the second interim analysis. We begin with the null hypothesis. The columns in the resulting table are - <code>z</code> - <span class="math inline">\(Z\)</span>-values for the grid; recall that each interim test statistic is normally distributed with variance 1 - <code>w</code> - weights for numerical integration - <code>h</code> - weights <code>w</code> times the normal density that can be used for numerical integration; we will demonstrate use below</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Set up grid over continuation region</span>
<span class="co"># Null hypothesis</span>
<span class="va">grid1_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/h1.html">h1</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fl">0</span>, I <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, a <span class="op">=</span> <span class="va">a1</span>, b <span class="op">=</span> <span class="va">b1</span><span class="op">)</span>
<span class="va">grid1_0</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 3</span></span>
<span class="co">#&gt;       z      w        h</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> -<span style="color: #BB0000;">2.00</span> 0.013<span style="text-decoration: underline;">5</span> 0.000<span style="text-decoration: underline;">733</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> -<span style="color: #BB0000;">1.96</span> 0.054<span style="text-decoration: underline;">0</span> 0.003<span style="text-decoration: underline;">17</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> -<span style="color: #BB0000;">1.92</span> 0.027<span style="text-decoration: underline;">4</span> 0.001<span style="text-decoration: underline;">74</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> -<span style="color: #BB0000;">1.88</span> 0.055<span style="text-decoration: underline;">6</span> 0.003<span style="text-decoration: underline;">82</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span> -<span style="color: #BB0000;">1.83</span> 0.027<span style="text-decoration: underline;">8</span> 0.002<span style="text-decoration: underline;">06</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">6</span> -<span style="color: #BB0000;">1.79</span> 0.055<span style="text-decoration: underline;">6</span> 0.004<span style="text-decoration: underline;">45</span></span></code></pre></div>
<p>The probability of not crossing a bound under the null hypothesis is computed as follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">probH0continue</span> <span class="op">&lt;-</span> <span class="va">grid1_0</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">h</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Probability of continuing trial under null hypothesis\n"</span>,
    <span class="st">" Using numerical integration:"</span>, <span class="va">probH0continue</span>, 
    <span class="st">"\n  Using normal cdf:"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">b1</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">a1</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span>
<span class="co">#&gt; Probability of continuing trial under null hypothesis</span>
<span class="co">#&gt;   Using numerical integration: 0.9755632 </span>
<span class="co">#&gt;   Using normal cdf: 0.9755632</span></code></pre></div>
<p>We now set up numerical integration grid under the alternate hypothesis and the compute continuation probability.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">grid1_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/h1.html">h1</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, I <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, a <span class="op">=</span> <span class="va">a1</span>, b <span class="op">=</span> <span class="va">b1</span><span class="op">)</span>
<span class="va">probH1continue</span> <span class="op">&lt;-</span> <span class="va">grid1_1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">h</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">h1mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Probability of continuing trial under alternate hypothesis\n"</span>,
    <span class="st">" Using numerical integration:"</span>, <span class="va">probH1continue</span>, 
    <span class="st">"\n  Using normal cdf:"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">b1</span>, mean <span class="op">=</span> <span class="va">h1mean</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">a1</span>, <span class="va">h1mean</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span>
<span class="co">#&gt; Probability of continuing trial under alternate hypothesis</span>
<span class="co">#&gt;   Using numerical integration: 0.986709 </span>
<span class="co">#&gt;   Using normal cdf: 0.986709</span></code></pre></div>
<ul>
<li>Compute initial iteration for analysis 2 bounds</li>
</ul>
<p>The initial estimate of the second analysis bounds are computed the same way as the actual first analysis bounds.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Upper bound under null hypothesis</span>
<span class="co"># incremental spend</span>
<span class="va">spend0</span> <span class="op">&lt;-</span> <span class="va">alphaspend</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">alphaspend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="co"># H0 bound at 2nd analysis; 1st approximation</span>
<span class="va">b2_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="va">spend0</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co"># Lower bound under alternate hypothesis</span>
<span class="va">spend1</span> <span class="op">&lt;-</span> <span class="va">betaspend</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">betaspend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="va">a2_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="va">spend1</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">info</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">theta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Initial bound approximation for 2nd analysis\n ("</span>,
    <span class="va">a2_0</span>, <span class="st">", "</span>, <span class="va">b2_0</span>,<span class="st">")\n"</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span>
<span class="co">#&gt; Initial bound approximation for 2nd analysis</span>
<span class="co">#&gt;  (1.681989, 1.987428)</span></code></pre></div>
<ul>
<li>Compute actual boundary crossing probabilities with initial approximations</li>
</ul>
<p>To get actual boundary crossing probabilities at the second analysis, we update our numerical integration grids. Under the null hypothesis, we need to update to the interval above <code>b2_0</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Upper rejection region grid under H0</span>
<span class="va">grid2_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hupdate.html">hupdate</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fl">0</span>, I <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, a <span class="op">=</span> <span class="va">b2_0</span>, b <span class="op">=</span> <span class="cn">Inf</span>, Im1 <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, gm1 <span class="op">=</span> <span class="va">grid1_0</span><span class="op">)</span>
<span class="va">pupper_0</span> <span class="op">&lt;-</span> <span class="va">grid2_0</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">h</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Upper spending at analysis 2\n Target:"</span>, <span class="va">spend0</span>, <span class="st">"\n Using initial bound approximation:"</span>,
    <span class="va">pupper_0</span>,<span class="st">"\n"</span><span class="op">)</span>
<span class="co">#&gt; Upper spending at analysis 2</span>
<span class="co">#&gt;  Target: 0.0234375 </span>
<span class="co">#&gt;  Using initial bound approximation: 0.02290683</span></code></pre></div>
<p>To get a first order Taylor’s series approximation to update this bound, we need the derivative of the above probability with respect to the Z-value cutoff. This was given above as the subdensity computed in the grid. As before, the grid contains the numerical integration weight in <code>w</code> and that weight times the subdensity in <code>h</code>. Thus, to get the subdensity at the bound, which is the estimated derivative in the boundary crossing probability, we compute:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># First point in grid is at bound</span>
<span class="co"># Compute derivative</span>
<span class="va">dpdb2</span> <span class="op">&lt;-</span> <span class="va">grid2_0</span><span class="op">$</span><span class="va">h</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="va">grid2_0</span><span class="op">$</span><span class="va">w</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="co"># Compute difference between target and actual bound crossing probability</span>
<span class="va">pdiff</span> <span class="op">&lt;-</span> <span class="va">spend0</span> <span class="op">-</span> <span class="va">pupper_0</span>
<span class="co"># Taylor's series update</span>
<span class="va">b2_1</span> <span class="op">&lt;-</span> <span class="va">b2_0</span> <span class="op">-</span> <span class="va">pdiff</span> <span class="op">/</span> <span class="va">dpdb2</span>
<span class="co"># Compute boundary crossing probability at updated bound</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Original bound approximation:"</span>, <span class="va">b2_0</span>, 
    <span class="st">"\nUpdated bound approximation:"</span>, <span class="va">b2_1</span>
    <span class="op">)</span>
<span class="co">#&gt; Original bound approximation: 1.987428 </span>
<span class="co">#&gt; Updated bound approximation: 1.977726</span>
<span class="va">grid2_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hupdate.html">hupdate</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fl">0</span>, I <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, a <span class="op">=</span> <span class="va">b2_1</span>, b <span class="op">=</span> <span class="cn">Inf</span>, Im1 <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, gm1 <span class="op">=</span> <span class="va">grid1_0</span><span class="op">)</span>
<span class="va">pupper_1</span> <span class="op">&lt;-</span> <span class="va">grid2_0</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">h</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nOriginal boundary crossing probability:"</span>, <span class="va">pupper_0</span>, 
    <span class="st">"\nUpdated boundary crossing probability:"</span>, <span class="va">pupper_1</span>,
    <span class="st">"\nTarget:"</span>, <span class="va">spend0</span>, <span class="st">"\n"</span>
    <span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Original boundary crossing probability: 0.02290683 </span>
<span class="co">#&gt; Updated boundary crossing probability: 0.02344269 </span>
<span class="co">#&gt; Target: 0.0234375</span></code></pre></div>
<p>We see that the Taylor’s series update has gotten us substantially closer to the targeted boundary probability. We now update the lower bound in an analogous fashion.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Lower rejection region grid under H1</span>
<span class="va">grid2_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hupdate.html">hupdate</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="va">theta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, I <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, a <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, b <span class="op">=</span> <span class="va">a2_0</span>, 
                   thetam1 <span class="op">=</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, Im1 <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, gm1 <span class="op">=</span> <span class="va">grid1_1</span><span class="op">)</span>
<span class="va">plower_0</span> <span class="op">&lt;-</span> <span class="va">grid2_1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">h</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span>
<span class="co"># Last point in grid is at bound</span>
<span class="co"># Compute derivative</span>
<span class="va">indx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">grid2_1</span><span class="op">)</span>
<span class="va">dpda2</span> <span class="op">&lt;-</span> <span class="va">grid2_1</span><span class="op">$</span><span class="va">h</span><span class="op">[</span><span class="va">indx</span><span class="op">]</span> <span class="op">/</span> <span class="va">grid2_1</span><span class="op">$</span><span class="va">w</span><span class="op">[</span><span class="va">indx</span><span class="op">]</span>
<span class="co"># Compute difference between target and actual bound crossing probability</span>
<span class="va">pdiff</span> <span class="op">&lt;-</span> <span class="va">spend1</span> <span class="op">-</span> <span class="va">plower_0</span>
<span class="co"># Taylor's series update</span>
<span class="va">a2_1</span> <span class="op">&lt;-</span> <span class="va">a2_0</span> <span class="op">+</span> <span class="va">pdiff</span> <span class="op">/</span> <span class="va">dpda2</span>
<span class="co"># Compute boundary crossing probability at updated bound</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Original bound approximation:"</span>, <span class="va">a2_0</span>, 
    <span class="st">"\nUpdated bound approximation:"</span>, <span class="va">a2_1</span>
    <span class="op">)</span>
<span class="co">#&gt; Original bound approximation: 1.681989 </span>
<span class="co">#&gt; Updated bound approximation: 1.702596</span>
<span class="va">grid2_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hupdate.html">hupdate</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="va">theta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, I <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, a <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, b <span class="op">=</span> <span class="va">a2_1</span>, 
                   thetam1 <span class="op">=</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, Im1 <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, gm1 <span class="op">=</span> <span class="va">grid1_1</span><span class="op">)</span>
<span class="va">plower_1</span> <span class="op">&lt;-</span> <span class="va">grid2_1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">h</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nOriginal boundary crossing probability:"</span>, <span class="va">plower_0</span>, 
    <span class="st">"\nUpdated boundary crossing probability:"</span>, <span class="va">plower_1</span>,
    <span class="st">"\nTarget:"</span>, <span class="va">spend1</span>, <span class="st">"\n"</span>
    <span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Original boundary crossing probability: 0.09035972 </span>
<span class="co">#&gt; Updated boundary crossing probability: 0.09379707 </span>
<span class="co">#&gt; Target: 0.09375</span></code></pre></div>
<ul>
<li>Confirm with <code><a href="../reference/gs_power_npe.html">gs_power_npe()</a></code>
</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/gs_power_npe.html">gs_power_npe</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="va">theta</span>, theta1 <span class="op">=</span> <span class="va">theta</span>, info <span class="op">=</span> <span class="va">info</span>, binding <span class="op">=</span> <span class="cn">TRUE</span>,
             upper <span class="op">=</span> <span class="va">gs_spending_bound</span>,
             upar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sf <span class="op">=</span> <span class="fu">gsDesign</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/gsDesign/man/sfPower.html" class="external-link">sfPower</a></span>, total_spend <span class="op">=</span> <span class="fl">0.025</span>, param <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,
             lower <span class="op">=</span> <span class="va">gs_spending_bound</span>,
             lpar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sf <span class="op">=</span> <span class="fu">gsDesign</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/gsDesign/man/sfPower.html" class="external-link">sfPower</a></span>, total_spend <span class="op">=</span> <span class="fl">0.1</span>, param <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 9</span></span>
<span class="co">#&gt;   Analysis Bound     Z Probability theta theta1  info info0 info1</span>
<span class="co">#&gt;      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span>        1 Upper  2.96     0.007<span style="text-decoration: underline;">04</span>   0.5    0.5     1     1     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span>        2 Upper  1.98     0.845     1.5    1.5     4     4     4</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span>        1 Lower -<span style="color: #BB0000;">2.00</span>     0.006<span style="text-decoration: underline;">25</span>   0.5    0.5     1     1     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span>        2 Lower  1.70     0.100     1.5    1.5     4     4     4</span></code></pre></div>
</div>
</div>
<div class="section level1 unnumbered">
<h1 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h1>
<div id="refs" class="references">
<div id="ref-JTBook">
<p>Jennison, Christopher, and Bruce W. Turnbull. 2000. <em>Group Sequential Methods with Applications to Clinical Trials</em>. Boca Raton, FL: Chapman; Hall/CRC.</p>
</div>
<div id="ref-PLWBook">
<p>Proschan, Michael A., K. K. Gordon Lan, and Janet Turk Wittes. 2006. <em>Statistical Monitoring of Clinical Trials. A Unified Approach.</em> New York, NY: Springer.</p>
</div>
<div id="ref-Tsiatis">
<p>Tsiatis, Anastasios A. 1982. “Repeated Significance Testing for a General Class of Statistics Use in Censored Survival Analysis.” <em>Journal of the American Statistical Association</em> 77: 855–61.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Keaven Anderson. Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1. <br>Copyright © Merck Sharp &amp; Dohme Corp., a subsidiary of Merck &amp; Co., Inc., Kenilworth, NJ, USA.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p><span></span></p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
