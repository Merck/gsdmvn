---
title: "Power for delayed effect scenarios"
author: "Keaven M. Anderson and Yujie Zhao"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 2
    number_sections: yes
subtitle: Impact of study duration on power
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, message=FALSE, warning=FALSE}
library(gsDesign)
library(gsDesign2)
library(gsdmvn)
library(ggplot2)
library(dplyr)
library(gt)
library(tidyr)
library(tibble)
```

# Overview

We consider a delayed effect scenario where 

- The control group time-to-event distribution is exponential with a median of 15 months.
- The experimental group has a hazard ratio vs. control of 1 for 6 months and 0.6 thereafter.
- Enrollment at a constant rate for 12 months.
- Total study duration from 20 to 48 months.
- Exponential dropout rate of 0.001 per month.

For the above scenarios, we compute sample size and events required using the Fleming-Harrington $\rho=0, \gamma=0.5$ test to obtain power of 85% given 1-sided Type I error of 0.025. 
We then compute power for the logrank test.
The general summary is that the Fleming-Harrington test has a meaningful power gain relative to logrank regardless of the study durations evaluated.



```{r}
enrollRates <- tibble(Stratum = "All", duration = 12, rate = 1)
failRates <- tibble(Stratum = "All",
                            duration = c(6, 100),
                            failRate = log(2) / 15,
                            hr = c(1, .6),
                            dropoutRate = 0.001)
tab <- NULL
for(trial_duration in seq(20, 60, 4)){
  FH05 <- 
    gs_design_wlr(
       enrollRates = enrollRates, 
       failRates = failRates,
       ratio = 1, 
       alpha = 0.025, beta = 0.15,
       weight = function(x, arm0, arm1){
         gsdmvn:::wlr_weight_fh(x, arm0, arm1, rho = 0, gamma = 0.5)},
       upar = qnorm(.975),
       lpar = -Inf,
       analysisTimes = trial_duration)   
  FH00 <- 
    gs_power_wlr(
       enrollRates = FH05$enrollRates, 
       failRates = failRates,
       ratio = 1, 
       weight = function(x, arm0, arm1){
         gsdmvn:::wlr_weight_fh(x, arm0, arm1, rho = 0, gamma = 0)},
       upar = qnorm(.975),
       lpar = -Inf,
       analysisTimes = trial_duration,
       events = .1) %>%
    summary_bound() %>% ungroup() %>% filter(Bound == "Efficacy")
  mc2_test <- data.frame(rho = 0, gamma = c(0, .5), tau = -1,
                         test = 1:2, Analysis = 1, analysisTimes = trial_duration)
  MC2 <-
  gs_power_combo(enrollRates = FH05$enrollRates, failRates = failRates, fh_test = mc2_test,
                 upper = gs_spending_combo,
                 upar  = list(sf = gsDesign::sfLDOF, total_spend = 0.025),
                 lower = gs_spending_combo,
                 lpar  = list(sf = gsDesign::sfLDOF, total_spend = 0.01))
  mc3_test <- data.frame(rho = c(0,0,.5), gamma = c(0, .5, .5), tau = -1,
                         test = 1:3, Analysis = 1, analysisTimes = trial_duration)
  MC3 <-
  gs_power_combo(enrollRates = FH05$enrollRates, failRates = failRates, fh_test = mc3_test,
                 upper = gs_spending_combo,
                 upar  = list(sf = gsDesign::sfLDOF, total_spend = 0.025),
                 lower = gs_spending_combo,
                 lpar  = list(sf = gsDesign::sfLDOF, total_spend = 0.01))
  mc4_test <- data.frame(rho = c(0,0,.5,.5), gamma = c(0, .5, .5, 0), tau = -1,
                         test = 1:4, Analysis = 1, analysisTimes = trial_duration)
  MC4 <-
  gs_power_combo(enrollRates = FH05$enrollRates, failRates = failRates, fh_test = mc4_test,
                 upper = gs_spending_combo,
                 upar  = list(sf = gsDesign::sfLDOF, total_spend = 0.025),
                 lower = gs_spending_combo,
                 lpar  = list(sf = gsDesign::sfLDOF, total_spend = 0.01))
  MB6 <- 
    gs_power_wlr(
       enrollRates = FH05$enrollRates, 
       failRates = failRates,
       ratio = 1, 
       weight = function(x, arm0, arm1){
         gsdmvn:::wlr_weight_fh(x, arm0, arm1, rho = -1, gamma = 0, tau = 6)},
       upar = qnorm(.975),
       lpar = -Inf,
       analysisTimes = trial_duration,
       events = .1) %>%
    summary_bound() %>% ungroup() %>% filter(Bound == "Efficacy")
  tab <-
    rbind(tab, 
        cbind(
              FH05 %>% 
              summary_bound() %>% ungroup() %>% 
              transmute("Study duration" = FH05$analysis$Time[1], N = FH05$analysis$N[1], Events = FH05$analysi$Events[1], 
                        "Events/N" = Events/N, AHR = as.numeric(FH00[4]), "FH(0, 0.5) power" = `Alternate hypothesis`),
              FH00 %>% ungroup() %>% transmute("Logrank power" = `Alternate hypothesis`, 
                                               "MC4 power" = as.numeric(MC4$Probability[1]),
                                               "MC3 power" = as.numeric(MC3$Probability[1]),
                                               "MC2 power" = as.numeric(MC2$Probability[1]),
                                               "MB6 power" = as.numeric(MB6[1,6]))
       ))
}
tab %>% gt() %>%
  fmt_number(columns = c(2,3), decimals = 1) %>%
  fmt_number(columns = c(4,6:10) + 1, decimals = 3) %>%
  fmt_number(columns = 4:6, decimals = 2)
```


Now we consider an alternate where the placebo group starts with the same median, but then has a piecewise change to a median of 30 after 16 months and with a hazard ratio of 0.85 during that late period.


```{r}
enrollRates <- tibble(Stratum = "All", duration = 12, rate = 1)
failRates <- tibble(Stratum = "All",
                            duration = c(6, 100),
                            failRate = log(2) / 15,
                            hr = c(1, .6),
                            dropoutRate = 0.001)
tab <- NULL
for(trial_duration in seq(20, 60, 4)){
  FH05 <- 
    gs_design_wlr(
       enrollRates = enrollRates, 
       failRates = failRates,
       ratio = 1, 
       alpha = 0.025, beta = 0.15,
       weight = function(x, arm0, arm1){
         gsdmvn:::wlr_weight_fh(x, arm0, arm1, rho = 0, gamma = 0.5)},
       upar = qnorm(.975),
       lpar = -Inf,
       analysisTimes = trial_duration)   
  FH00 <- 
    gs_power_wlr(
       enrollRates = FH05$enrollRates, 
       failRates = failRates,
       ratio = 1, 
       weight = function(x, arm0, arm1){
         gsdmvn:::wlr_weight_fh(x, arm0, arm1, rho = 0, gamma = 0)},
       upar = qnorm(.975),
       lpar = -Inf,
       analysisTimes = trial_duration,
       events = .1) %>%
    summary_bound() %>% ungroup() %>% filter(Bound == "Efficacy")
  mc2_test <- data.frame(rho = 0, gamma = c(0, .5), tau = -1,
                         test = 1:2, Analysis = 1, analysisTimes = trial_duration)
  MC2 <-
  gs_power_combo(enrollRates = FH05$enrollRates, failRates = failRates, fh_test = mc2_test,
                 upper = gs_spending_combo,
                 upar  = list(sf = gsDesign::sfLDOF, total_spend = 0.025),
                 lower = gs_spending_combo,
                 lpar  = list(sf = gsDesign::sfLDOF, total_spend = 0.01))
  mc3_test <- data.frame(rho = c(0,0,.5), gamma = c(0, .5, .5), tau = -1,
                         test = 1:3, Analysis = 1, analysisTimes = trial_duration)
  MC3 <-
  gs_power_combo(enrollRates = FH05$enrollRates, failRates = failRates, fh_test = mc3_test,
                 upper = gs_spending_combo,
                 upar  = list(sf = gsDesign::sfLDOF, total_spend = 0.025),
                 lower = gs_spending_combo,
                 lpar  = list(sf = gsDesign::sfLDOF, total_spend = 0.01))
  mc4_test <- data.frame(rho = c(0,0,.5,.5), gamma = c(0, .5, .5, 0), tau = -1,
                         test = 1:4, Analysis = 1, analysisTimes = trial_duration)
  MC4 <-
  gs_power_combo(enrollRates = FH05$enrollRates, failRates = failRates, fh_test = mc4_test,
                 upper = gs_spending_combo,
                 upar  = list(sf = gsDesign::sfLDOF, total_spend = 0.025),
                 lower = gs_spending_combo,
                 lpar  = list(sf = gsDesign::sfLDOF, total_spend = 0.01))
  MB6 <- 
    gs_power_wlr(
       enrollRates = FH05$enrollRates, 
       failRates = failRates,
       ratio = 1, 
       weight = function(x, arm0, arm1){
         gsdmvn:::wlr_weight_fh(x, arm0, arm1, rho = -1, gamma = 0, tau = 6)},
       upar = qnorm(.975),
       lpar = -Inf,
       analysisTimes = trial_duration,
       events = .1) %>%
    summary_bound() %>% ungroup() %>% filter(Bound == "Efficacy")
  tab <-
    rbind(tab, 
        cbind(
              FH05 %>% 
              summary_bound() %>% ungroup() %>% 
              transmute("Study duration" = FH05$analysis$Time[1], N = FH05$analysis$N[1], Events = FH05$analysi$Events[1], 
                        "Events/N" = Events/N, AHR = as.numeric(FH00[4]), "FH(0, 0.5) power" = `Alternate hypothesis`),
              FH00 %>% ungroup() %>% transmute("Logrank power" = `Alternate hypothesis`, 
                                               "MC4 power" = as.numeric(MC4$Probability[1]),
                                               "MC3 power" = as.numeric(MC3$Probability[1]),
                                               "MC2 power" = as.numeric(MC2$Probability[1]),
                                               "MB6 power" = as.numeric(MB6[1,6]))
       ))
}
tab %>% gt() %>%
  fmt_number(columns = c(2,3), decimals = 1) %>%
  fmt_number(columns = c(4,6:10) + 1, decimals = 3) %>%
  fmt_number(columns = 4:6, decimals = 2)
```


Now we consider an alternate where the placebo group starts with the same median, but then has a piecewise change to a median of 30 after 16 months and with a hazard ratio of 0.85 during that late period.


```{r}
enrollRates <- tibble(Stratum = "All", duration = 12, rate = 1)
failRates <- tibble(Stratum = "All",
                            duration = c(6, 10, 100),
                            failRate = log(2) / c(15, 15, 30),
                            hr = c(1, .6, .85),
                            dropoutRate = 0.001)
tab <- NULL
for(trial_duration in seq(20, 60, 4)){
  FH05 <- 
    gs_design_wlr(
       enrollRates = enrollRates, 
       failRates = failRates,
       ratio = 1, 
       alpha = 0.025, beta = 0.15,
       weight = function(x, arm0, arm1){
         gsdmvn:::wlr_weight_fh(x, arm0, arm1, rho = 0, gamma = 0.5)},
       upar = qnorm(.975),
       lpar = -Inf,
       analysisTimes = trial_duration)   
  FH00 <- 
    gs_power_wlr(
       enrollRates = FH05$enrollRates, 
       failRates = failRates,
       ratio = 1, 
       weight = function(x, arm0, arm1){
         gsdmvn:::wlr_weight_fh(x, arm0, arm1, rho = 0, gamma = 0)},
       upar = qnorm(.975),
       lpar = -Inf,
       analysisTimes = trial_duration,
       events = .1) %>%
    summary_bound() %>% ungroup() %>% filter(Bound == "Efficacy")
  mc2_test <- data.frame(rho = 0, gamma = c(0, .5), tau = -1,
                         test = 1:2, Analysis = 1, analysisTimes = trial_duration)
  MC2 <-
  gs_power_combo(enrollRates = FH05$enrollRates, failRates = failRates, fh_test = mc2_test,
                 upper = gs_spending_combo,
                 upar  = list(sf = gsDesign::sfLDOF, total_spend = 0.025),
                 lower = gs_spending_combo,
                 lpar  = list(sf = gsDesign::sfLDOF, total_spend = 0.01))
  mc3_test <- data.frame(rho = c(0,0,.5), gamma = c(0, .5, .5), tau = -1,
                         test = 1:3, Analysis = 1, analysisTimes = trial_duration)
  MC3 <-
  gs_power_combo(enrollRates = FH05$enrollRates, failRates = failRates, fh_test = mc3_test,
                 upper = gs_spending_combo,
                 upar  = list(sf = gsDesign::sfLDOF, total_spend = 0.025),
                 lower = gs_spending_combo,
                 lpar  = list(sf = gsDesign::sfLDOF, total_spend = 0.01))
  mc4_test <- data.frame(rho = c(0,0,.5,.5), gamma = c(0, .5, .5, 0), tau = -1,
                         test = 1:4, Analysis = 1, analysisTimes = trial_duration)
  MC4 <-
  gs_power_combo(enrollRates = FH05$enrollRates, failRates = failRates, fh_test = mc4_test,
                 upper = gs_spending_combo,
                 upar  = list(sf = gsDesign::sfLDOF, total_spend = 0.025),
                 lower = gs_spending_combo,
                 lpar  = list(sf = gsDesign::sfLDOF, total_spend = 0.01))
  MB6 <- 
    gs_power_wlr(
       enrollRates = FH05$enrollRates, 
       failRates = failRates,
       ratio = 1, 
       weight = function(x, arm0, arm1){
         gsdmvn:::wlr_weight_fh(x, arm0, arm1, rho = -1, gamma = 0, tau = 6)},
       upar = qnorm(.975),
       lpar = -Inf,
       analysisTimes = trial_duration,
       events = .1) %>%
    summary_bound() %>% ungroup() %>% filter(Bound == "Efficacy")
  tab <-
    rbind(tab, 
        cbind(
              FH05 %>% 
              summary_bound() %>% ungroup() %>% 
              transmute("Study duration" = FH05$analysis$Time[1], N = FH05$analysis$N[1], Events = FH05$analysi$Events[1], 
                        "Events/N" = Events/N, AHR = as.numeric(FH00[4]), "FH(0, 0.5) power" = `Alternate hypothesis`),
              FH00 %>% ungroup() %>% transmute("Logrank power" = `Alternate hypothesis`, 
                                               "MC4 power" = as.numeric(MC4$Probability[1]),
                                               "MC3 power" = as.numeric(MC3$Probability[1]),
                                               "MC2 power" = as.numeric(MC2$Probability[1]),
                                               "MB6 power" = as.numeric(MB6[1,6]))
       ))
}
tab %>% gt() %>%
  fmt_number(columns = c(2,3), decimals = 1) %>%
  fmt_number(columns = c(4,6:10) + 1, decimals = 3) %>%
  fmt_number(columns = 4:6, decimals = 2)
```




