---
title: "`info_scale` in `gs_power_npe`"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 4
    number_sections: yes
---

```{r, message=FALSE, warning=FALSE, echo=FALSE}
library(gsDesign)
library(dplyr)
library(gt)
library(testthat)
library(tibble)
library(gsdmvn)
#devtools::load_all()
```

# `gs_power_npe` 

## Case 1 {.tabset}

### `info_scale = 0`
```{r}
gs_power_npe(
  theta = .1, 
  info = 700, 
  info_scale = 0,
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = 500),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
  test_upper = TRUE,
  test_lower = TRUE) %>% gt()
```

### `info_scale = 1`
```{r}
gs_power_npe(
  theta = .1, 
  info = 700, 
  info_scale = 1,
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = 500),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
  test_upper = TRUE,
  test_lower = TRUE) %>% gt()
```


### `info_scale = 2`
```{r}
gs_power_npe(
  theta = .1, 
  info = 700, 
  info_scale = 2,
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = 500),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
  test_upper = TRUE,
  test_lower = TRUE) %>% gt()
```

## Case 2 {.tabset}

### `info_scale = 0`
```{r}
gs_power_npe(
  theta = .1, 
  info = 700, 
  info_scale = 0,
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
  test_upper = TRUE,
  test_lower = TRUE) %>% gt()
```

### `info_scale = 1`
```{r}
gs_power_npe(
  theta = .1, 
  info = 700, 
  info_scale = 1,
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
  test_upper = TRUE,
  test_lower = TRUE) %>% gt()
```


### `info_scale = 2`
```{r}
gs_power_npe(
  theta = .1, 
  info = 700, 
  info_scale = 2,
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
  test_upper = TRUE,
  test_lower = TRUE) %>% gt()
```



## Case 3 {.tabset}

### `info_scale = 0`
```{r}
gs_power_npe(
  theta = .1, 
  info = 700, 
  info_scale = 0,
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = 500),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = 800),
  test_upper = TRUE,
  test_lower = TRUE) %>% gt()
```

### `info_scale = 1`
```{r}
gs_power_npe(
  theta = .1, 
  info = 700, 
  info_scale = 1,
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = 500),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = 800),
  test_upper = TRUE,
  test_lower = TRUE) %>% gt()
```


### `info_scale = 2`
```{r}
gs_power_npe(
  theta = .1, 
  info = 700, 
  info_scale = 2,
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = 500),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = 800),
  test_upper = TRUE,
  test_lower = TRUE) %>% gt()
```




# `gs_design_npe`

## Case 1 {.tabset}

### `info_scale = 0`
```{r}
gs_design_npe(
  theta = .1,
  info = 700,
  info0 = NULL,
  info_scale = 0,
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = 500),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL))
  )
```

### `info_scale = 1`
```{r}
gs_design_npe(
  theta = .1,
  info = 700,
  info0 = NULL,
  info_scale = 1,
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = 500),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL))
  )
```

### `info_scale = 2`
```{r}
gs_design_npe(
  theta = .1,
  info = 700,
  info0 = NULL,
  info_scale = 2,
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = 500),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL))
  )
```


# Binary Endpoint {.tabset}

## `gsdmvn`

If one use `gs_spending_bound`, one can add `info` into the arguments `upar` and `lpar` as follows.
```{r}
x_info <- gs_info_rd(
  p_c = tibble::tibble(Stratum = "All", Rate = .28),
  p_e = tibble::tibble(Stratum = "All", Rate = .4),
  N = tibble::tibble(Stratum = "All", N = 650, Analysis = 1),
  rd0 = 0,
  ratio = 1
)

x_info %>% gt()
```


```{r}
x0 <- gs_design_rd(
  p_c = tibble::tibble(Stratum = "All", Rate = .28),
  p_e = tibble::tibble(Stratum = "All", Rate = .4),
  k = 1,
  rd0 = 0, 
  alpha = 0.025,   
  beta = 0.1,   
  ratio = 1,
  weight = "un-stratified",
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = x_info$info0),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = x_info$info),
  info_scale = 0)  

x1 <- gs_design_rd(
  p_c = tibble::tibble(Stratum = "All", Rate = .28),
  p_e = tibble::tibble(Stratum = "All", Rate = .4),
  k = 1,
  rd0 = 0, 
  alpha = 0.025,   
  beta = 0.1,   
  ratio = 1,
  weight = "un-stratified",
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = x_info$info0),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = x_info$info),
  info_scale = 1) 

x2 <- gs_design_rd(
  p_c = tibble::tibble(Stratum = "All", Rate = .28),
  p_e = tibble::tibble(Stratum = "All", Rate = .4),
  k = 1,
  rd0 = 0, 
  alpha = 0.025,   
  beta = 0.1,   
  ratio = 1,
  weight = "un-stratified",
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = x_info$info0),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
              info = x_info$info),
  info_scale = 2) 

cat("The sample size calculated by `gs_design_rd()` under `info_scale = 0` is ", x0$analysis$N, "\n")
cat("The sample size calculated by `gs_design_rd()` under `info_scale = 1` is ", x1$analysis$N, "\n")
cat("The sample size calculated by `gs_design_rd()` under `info_scale = 2` is ", x2$analysis$N, "\n")
```


But the above input of `info` in the arguments `upar` and `lpar` is optional. 
```{r}
xx0 <- gs_design_rd(
  p_c = tibble::tibble(Stratum = "All", Rate = .28),
  p_e = tibble::tibble(Stratum = "All", Rate = .4),
  k = 1,
  rd0 = 0, 
  alpha = 0.025,   
  beta = 0.1,   
  ratio = 1,
  weight = "un-stratified",
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
  info_scale = 0)

xx1 <- gs_design_rd(
  p_c = tibble::tibble(Stratum = "All", Rate = .28),
  p_e = tibble::tibble(Stratum = "All", Rate = .4),
  k = 1,
  rd0 = 0, 
  alpha = 0.025,   
  beta = 0.1,   
  ratio = 1,
  weight = "un-stratified",
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
  info_scale = 1)

xx2 <- gs_design_rd(
  p_c = tibble::tibble(Stratum = "All", Rate = .28),
  p_e = tibble::tibble(Stratum = "All", Rate = .4),
  k = 1,
  rd0 = 0, 
  alpha = 0.025,   
  beta = 0.1,   
  ratio = 1,
  weight = "un-stratified",
  upper = gs_spending_bound,
  lower = gs_spending_bound,
  upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
  lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
  info_scale = 2)

cat("The sample size calculated by `gs_design_rd()` under `info_scale = 0` is ", xx0$analysis$N, "\n")
cat("The sample size calculated by `gs_design_rd()` under `info_scale = 1` is ", xx1$analysis$N, "\n")
cat("The sample size calculated by `gs_design_rd()` under `info_scale = 2` is ", xx2$analysis$N, "\n")
```


## `gsDesign`
```{r}
x <- nBinomial(p1 = .28, p2 = .4, delta0 = 0, alpha = .025, sided = 1, beta = .1, outtype = 3)
cat("The sample size calculated by `gsDesign` is ", x$n, "\n")
```


## EAST 
```{r label = EastFix, echo = FALSE, fig.cap = "Sample size calculated by EAST", out.width = '90%'}
knitr::include_graphics("./figures/east_n_fix.png")
```
